Migracja bazy danych
==================

> Note|Uwaga: Funkcjonalność migrowania bazy danych została udostępniona od wersji 1.1.6.

Tak jak w przypadku kodu, struktura bazy danych zmienia się wraz z dewelopmentem i zarządzaniem aplikacji bazodanowej. Na przykład, podczas dewelopmentu, możemy chcieć dodać nowa tabelę, czy też, po przeniesieniu aplikacji na serwer produkcyjny, może powstać potrzeba dodania indeksu do kolumny. Ważne jest, aby śledzić te zmiany w strukturze bazy danych (nazywane **migracją**) tak jak to robimy z kodem. Jeśli kod źródłowy i baza danych rozsynchronizują się, jest bardzo prawdopodobne, że cały system przestanie działać. Z tego powodu, Yii dostarcza narzędzie do migracji, które może śledzić historię migracji bazy danych, aplikować nowe migracje lub też odwracać istniejące.

Następujące kroki pokazują sposób używania migracji bazy danych w trakcie dewelopmentu:

1. Jan utworzył nową migrację (np. dodał nową tabelę)
2. Jan skomitował nową migrację do systemu kontroli wersji (np. SVN, GIT)
3. Stefan ściągnął zmiany z systemy kontroli wersji i otrzymał nową migrację
4. Stefan zaaplikował nową migrację na swoją lokalną bazę danych


Yii wspiera migrację bazy danych poprzez narzędzie linii poleceń `yiic migrate`. Narzędzie to wspiera tworzenie nowych migracji, aplikowanie/usuwanie/poprawianie migracji oraz wyświetlanie nowych migracji oraz ich historii.

W dalszej części opiszemy w jaki sposób używać to narzędzie.


Tworzenie migracji
-------------------

W celu utworzenia nowej migracji (np. utworzenie nowej tabeli), uruchamiamy następujące polecenie:

~~~
yiic migrate create <name>
~~~

Wymagany parametr `name` bardzo określa zwięźle opisuje migrację (np. `create_news_table`). Jak zobaczymy w dalszej części, parametr `name` używany jest jako część klasy PHP. Z tej przyczyny powinien zawierać jedynie litery, cyfry i/lub znaki podkreślenia.

~~~
yiic migrate create create_news_table
~~~

Powyższe polecenie utworzy w katalogu `protected/migrations` nowy plik nazwany `m20101129_185401_create_news_table.php`, który zawierać będzie następujący, początkowy kod:

~~~
[php]
class m101129_185401_create_news_table extends CDbMigration
{
	public function up()
	{
	}

    /*
    public function down()
    {
    }
    */
}
~~~

Zauważ, że nazwa klasy jest taka sama jak nazwa pliku, zgodnie z wzorcem `m<timestamp>_<name>`, gdzie `<timestamp>` wskazuje na stempel czasu UTC (w domyślnym formacie `yymmdd_hhmmss`) w którym to migracja została utworzona, a wartość reprezentująca `<name>` pobierana jest z parametru `name` polecenia.

Metoda `up()` powinna zawierać kod implementujący aklualną migrację bazy danych, podczas gdy metoda `down()` może zawierać kod odwracający to, co zostało zrobione w `up()`.

Czasami niemożliwe jest zaimplementowanie metody `down()`. Na przykład, jeśli usunęliśmy wiersze tabeli w metodzie `up()`, nie będziemy w stanie ich odtwozyć w metodzie `down()`. W takim przypadku migracja nazywana jest nieodwracalną, co oznacza, że nie możemy powrócić do poprzedniego stan bazy danych.

W ramach przykładu pokażmy migrację tworzącą tabelę wiadomości.

~~~
[php]
class m101129_185401_create_news_table extends CDbMigration
{
	public function up()
	{
		$this->createTable('tbl_news', array(
			'id' => 'pk',
			'title' => 'string NOT NULL',
			'content' => 'text',
		));
	}

	public function down()
	{
		$this->dropTable('tbl_news');
	}
}
~~~

Klasa bazowa [CDbMigration] dostarcza metod manipulujących danymi oraz schematem bazy danych. Na przykład, metoda [CDbMigration::createTable] utworzy tabelę w bazie danych, zaś metoda [CDbMigration::insert] wstawi wiersz danych. Wszystkie te metody używają połączenia z bazą danych zwracanego przez metodę [CDbMigration::getDbConnection()], która domyślnie zwraca `Yii::app()->db`.

> Info|Info: Jak można zauważyć, metody bazodanowe dostarczane przez [CDbMigration] są bardzo podobne dp tych z [CDbCommand]. Rzeczywiście są one takie same z tym wyjątkien, że metody [CDbMigration] odmierzają czas używany przez przez nie zużyty oraz wyświetlają pewne informację o parametrach metody.


Aplikowanie migracji
-------------------

W celu zastosowanie wszystkich nowodostępnych migracji (np. by zaktualizować lokalną wersję bazy danych) uruchom następujące polecenie:

~~~
yiic migrate
~~~

Polecenie wyświetli listę wszystkich nowych migracji. Jeśli potwierdzisz zaaplikowanie tych migracji, polecenie to wywoła metodę `up()` każdej z klasy migracyjnych, jedna po drugiej, w kolejności wartości znacznika czasu (ang. timestamp) zapisanego w nazie klasy.

Po zastosowaniu migracji, narzędzie migrujace zachowa rekord w tabeli o nazwie `tbl_migration`. Pozwoli to narzędziu zidentyfikować, które migracje zostały zaaplikowane a które nie. Jeśli tabela `tbl_migration` nie istnieje, narzędzie utworzy ją w bazie danych określonej przez komponent aplikacji `db`.

Czasami możemy chcież jedynie zaaplikować jedną lub kilka migracji. W tym celu używamy następującego polecenia:

~~~
yiic migrate up 3
~~~

Polecenie to zaaplikuje 3 nowe migracje. Zmieniając wartość 3 zmieniamy ilość migracji, które mają zostać zaaplikowane.

Możemy również zmigrować bazę danych do określonej wersji za pomocą następującego polecenia:

~~~
yiic migrate to 101129_185401
~~~

Oznacza to, że korzystamy z części nazwy migracji zawierającej informację o stemplu czasowym w celu określenia wersji, do której chcemy zmigorwać baze danych. Jeśli pomiędzy ostatnio zastosowaną migracją a określoną przez nas występują inne, wszystkie te migracje zostaną zaaplikowane. Jeśli określona migracja zostałą zaaplikowana wcześniej, wtedy wszystkie migracje określone po niej zostaną odwrócone (zostanie to opisane w dalszej części).


Odwracanie migracji
--------------------

W celu odwrócenia ostaniej lub kilku ostatnio zaaplikowanych migracji, możemy użyć następującego polecenia:

~~~
yiic migrate down [step]
~~~

Polecenie to wywoła metodę `down()` dla kilku ostatnio zaaplikowanych migracji. Zmienianie parametru `step` pozwala nam zmieniać ilość migracji, które chcemy odwrócić. Jeśli parametr nie został określony przyjmuje on wartość domyślną 1, oznaczającą odwrócenie jednej migracji naraz.

Tak jak wspominaliśmy wcześniej nie wszystkie migracje można odwrócic. Próbując odwrócić ten typ migracji otrzymamy wyjątek i przerwiemy cały proces.


Przywracanie migracji
------------------

Przywracanie migracji oznacza odwrócenie a następnie zaaplikowanie określonej migracji. Może to być zrobione za pomocą następującego polecenia:

~~~
yiic migrate redo 3
~~~

Polecenie to odwróci a następnie zaaplikuje ostatnio 3 zaaplikowane migracje. Jeśli wartość 3 nie została przekazana, polecenie to odwróci a następnie zaaplikuje ostatnio zaaplikowaną migrację.


Wyświetlanie informacji o migracji
-----------------------------

Poza aplikowaniem i odwracaniem migracji, narzędzie do migracji potrafi również wyświetlić historię migracji oraz nową migrację, gotowe do zaaplikowania.

~~~
yiic migrate history 10
yiic migrate list 10
~~~

Pierwsze polecenie pokaże ostatnie 10 migracji, które zostały zaaplikowane wraz z czasem kiedy się to stało. Drugie polecenie wyświetli listę 10 migracji, które nie zostały jeszcze zaaplikowane.


Dostosowywanie narzędzia migracji
--------------------------

Narzędzie migracyjne może zostać dostosowane w pary obszarach. By to uczynić, musimy zmodyfikować plik konfiguracji aplikacji konsolowej poprzez dodanie następującego kodu:

~~~
[php]
return array(
	......
	'commandMap'=>array(
		'migrate'=>array(
			'class'=>'system.cli.commands.MigrateCommand',
			'migrationPath'=>'path/to/migrations',
			'migrationTable'=>'migration_table_name',
			'connectionID'=>'db_app_id',
			'templateFile'=>'path/to/template',
		),
		......
	),
	......
);
~~~

Powyższy kod pozwala skonfigurować kilka właściwości narzędzia migracji:

* `migrationPath`: łańcuch znaków, określa katalog przechowywujący wszystkie klasy z migracjami. Jeśli nie został podany, będzie wskazywał podkatalog `migrations` w ścieżce głównej aplikacji.

* `migrationTable`: łańcuch, określa nazwę tabeli w bazie danych przechowującą historię migracji. Domyślna nazwa to `tbl_migration`. Struktura tabeli jest następująca `version varchar(255) primary key, apply_time integer`.

* `connectionID`: łańcuch, określa identyfikator ID komponentu bazodanowego aplikacji. Domyślnie 'db'.

* `templateFile`: łańcuch, określa ścieżkę do pliku, który posłuży jako szablon kodu do generowania klasy migracji. Jeśli pusty, wewnętrzy szablon zostanie użyty. W szablonie token `{ClassName}` zostanie zastąpiony przez aktualną nazwę klasy.


<div class="revision">$Id: database.migration.txt 2703 2010-12-02 05:28:08Z qiang.xue $</div>