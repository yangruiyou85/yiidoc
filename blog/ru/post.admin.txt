Управление записями
===================

Под управлением записями подразумевается отображение их списка в административном
разделе с возможностью просматривать записи с любым статусом, редактировать и
удалять их. Этот функционал реализуется в действиях `admin` и `delete`
соответственно. Код, сгенерированный при помощи `yiic` почти не нуждается в
изменениях. Ниже мы объясним, как реализованы эти действия.


Отображение записей в виде таблицы
----------------------------------

Действие `admin` выводит записи со всеми статусами в виде таблицы,
разбитой на несколько страниц и поддерживающей сортировку по нескольким колонкам.
Далее приведён метод `actionAdmin()` контроллера `PostController`:

~~~
[php]
public function actionAdmin()
{
	$dataProvider=new CActiveDataProvider('Post', array(
		'sort'=>array(
			'defaultOrder'=>'status, update_time DESC',
		),
	));

	$this->render('admin',array(
		'dataProvider'=>$dataProvider,
	));
}
~~~

Данный код очень похож на используемый в `actionIndex()`. Главное отличие
выражается в критерии запроса. В данном случае мы не указываем какой-либо
критерий так как хотим показать все записи. Мы изменяем свойство `sort` провайдера
данных так, чтобы по умолчанию записи сортировались по статусу и времени их
обновления.

Ниже приведён код отображения `admin`:

~~~
[php]
<h1>Manage Posts</h1>

<?php $this->widget('zii.widgets.grid.CGridView', array(
	'dataProvider'=>$dataProvider,
	'columns'=>array(
		array(
			'name'=>'title',
			'type'=>'raw',
			'value'=>'CHtml::link(CHtml::encode($data->title), $data->url)'
		),
		array(
			'name'=>'status',
			'value'=>'Lookup::item("PostStatus",$data->status)',
		),
		'create_time:datetime',
		'update_time:datetime',
		array(
			'class'=>'CButtonColumn',
		),
	),
)); ?>
~~~

Для вывода записей мы используем компонент [[CGridView]], который позволяет
разбивает данные на страницы и позволяет их сортировать по столбцам.
Наше изменение касается, главным образом, отображения каждого столбца.
К примеру, для столбца `title` мы указываем, что он должен содержать
ссылку на просмотр записи.

> Tip|Подсказка: При выводе текста мы используем [CHtml::encode()] для
  кодирования сущностей HTML. Это позволяет избежать атак через [межсайтовый
  скриптинг](/doc/guide/ru/topics.security).


Удаление записей
----------------

В data grid `admin` в каждой строке есть кнопка «Удалить», удаляющая соответствующую
запись. Действие `delete` выглядит следующим образом:

~~~
[php]
public function actionDelete()
{
	if(Yii::app()->request->isPostRequest)
	{
		// we only allow deletion via POST request
		$this->loadModel()->delete();

		if(!isset($_POST['ajax']))
			$this->redirect(array('index'));
	}
	else
		throw new CHttpException(400,'Invalid request. Please do not repeat this request again.');
}
~~~

Приведённый выше код полностью сгенерирован `yiic`. Остановимся подробнее на
проверке `$_POST['ajax']`. В виджете [[CGridView]] сортировка, постраничная
разбивка и удаление по умолчанию реализованы с использованием AJAX. То есть при
выполнении перечисленных действий страница перезагружаться не будет.
Виджет может работать и без AJAX (если свойство `ajaxUpdate` выставлено в
`false` или отключен JavaScript). В действии `delete` при AJAX запросе перенаправление
производиться не должно.

Удаление записи должно вызывать удаление всех комментариев к ней. Вдобавок,
мы должны обновить теги в таблице `tbl_tag`. Обе задачи могут быть выполнены
в методе `afterDelete` модели `Post`:

~~~
[php]
protected function afterDelete()
{
	parent::afterDelete();
	Comment::model()->deleteAll('post_id='.$this->id);
	Tag::model()->updateFrequency($this->tags, '');
}
~~~

Код, приведённый выше не сложен: сначала удаляются все комментарии, чей
`post_id` равен ID удаляемой записи. Далее обнвляется таблица `tbl_tag`.

> Tip|Подсказка: Мы удаляем комментарии удаляемой записи в коде так как SQLite
> не поддерживает ограничения по внешнему ключу. В СУБД, которые данное ограничение
> поддерживают (например, MySQL или PostgreSQL), можно использовать каскадное
> удаление комментариев в случае удаления записи. В этом случае нет необходимости
> удалять комментарии в коде.

<div class="revision">$Id: post.admin.txt 1695 2010-01-10 01:30:06Z qiang.xue $</div>